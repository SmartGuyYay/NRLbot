<!DOCTYPE html>
<html>
<head>
  <title>React Bot ü§ñüèâ</title>
  <style>
    body { font-family: Arial; background:#222; color:#eee; }
    #chatbox { width: 90%; height: 400px; overflow-y: auto; border: 1px solid #555; padding: 10px; margin-bottom: 10px; }
    .user { color: #0f0; }
    .bot { color: #0af; }
    input { width:70%; padding:8px; border-radius:6px; border:none; }
    button { padding:8px; border-radius:6px; border:none; background:#0ea5e9; color:#fff; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>

<h2>React Bot ü§ñüèâ</h2>
<div id="chatbox"></div>
<input id="msg" type="text" placeholder="Type message..." autocomplete="off"/>
<button id="sendBtn">Send</button>
<button id="micBtn">üé§ Dictate</button>

<script>
const API_KEY = "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"; // ‚ö†Ô∏è exposed in browser

const chatbox = document.getElementById("chatbox");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");

let typingTimer;
const TYPING_DELAY = 1000; // 1s after stop typing

// --- Typing auto-submit ---
msgInput.addEventListener("input", () => {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => sendMessage(msgInput.value.trim()), TYPING_DELAY);
});

// --- Enter key sends ---
msgInput.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(msgInput.value.trim()); });
sendBtn.addEventListener("click", () => sendMessage(msgInput.value.trim()));

// --- Speech Recognition ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognizing = false;
let rec;

if(SpeechRecognition){
  rec = new SpeechRecognition();
  rec.lang = "en-AU";
  rec.interimResults = true;
  rec.continuous = false;

  rec.onresult = (e) => {
    let interim = "";
    let finalText = "";
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal) finalText += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    msgInput.value = finalText + interim;
  }

  rec.onend = () => {
    recognizing = false;
    micBtn.textContent = "üé§ Dictate";
    if(msgInput.value.trim()) sendMessage(msgInput.value.trim());
  }

  micBtn.addEventListener("click", () => {
    if(recognizing){ rec.stop(); return; }
    recognizing = true;
    micBtn.textContent = "‚èπÔ∏è Stop";
    rec.start();
  });
} else {
  micBtn.disabled = true;
  micBtn.textContent = "Speech not supported";
}

// --- Helper ---
function looksLikeQuestion(text) {
  return text.endsWith("?") || 
         ["what","why","how","when","who","where","can","does","is","are","explain"]
         .some(word => text.toLowerCase().startsWith(word));
}

// --- Send message ---
async function sendMessage(message){
  if(!message) return;
  msgInput.value = "";
  chatbox.innerHTML += `<div class='user'><b>You:</b> ${message}</div>`;
  chatbox.scrollTop = chatbox.scrollHeight;

  // Decide mode
  const force_serious = message.startsWith("!s");
  const force_roast = message.startsWith("!r");
  const is_question = looksLikeQuestion(message);

  let system_prompt;
  const username = "WebUser";

  if(force_serious || (is_question && !force_roast)){
    system_prompt = "You're React Bot: an Aussie NRL fan who can answer questions properly, who doesn't support any NRL team. TheLeaguie (aka. The Leaguie) lives at ANU Campus in Canberra.\n- Answer factually and clearly.\n- Never swear.";
  } else {
    system_prompt = "You're React Bot: a savage Aussie NRL fan, who doesn't support any NRL team.\n- Respond with short, funny one-liner roasts.\n- Use footy slang.\n- Keep under 25 words.";
  }

  try {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [
          { role: "system", content: system_prompt },
          { role: "user", content: message }
        ],
        temperature: 0.85
      })
    });

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "‚ùå No response";

    chatbox.innerHTML += `<div class='bot'><b>Bot:</b> ${reply}</div>`;
    chatbox.scrollTop = chatbox.scrollHeight;

    // --- Speak ---
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance(reply);
      u.lang = "en-AU";
      u.rate = 0.95;
      speechSynthesis.speak(u);
    }

  } catch(err) {
    chatbox.innerHTML += `<div class='bot'>‚ö†Ô∏è Error: ${err}</div>`;
  }
}
</script>

</body>
</html>
