<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NRL React Bot</title>
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; text-align:center; padding:32px 16px; }
    h1 { margin:0 0 10px; }
    .btn { padding:14px 22px; font-size:16px; border:0; border-radius:12px; cursor:pointer; background:#0ea5e9; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .box { max-width:700px; margin:16px auto; text-align:left; padding:14px 16px; border-radius:12px; }
    .heard { background:#121212; border:1px solid #2a2a2a; min-height:64px; white-space:pre-wrap; }
    .reaction { background:#1e1e1e; border:1px solid #3a3a3a; font-style:italic; }
    .support { margin-top:8px; opacity:.8; }
    #face { font-size:60px; margin-top:18px; }
    #eyes { display:flex; justify-content:center; gap:60px; margin-bottom:8px; }
    .eye { font-size:50px; }
    #mouth { font-size:60px; display:inline-block; transform-origin:center; }
    .talking { animation:talk .28s infinite; }
    @keyframes talk { 0%{transform:scaleY(1)} 50%{transform:scaleY(.35)} 100%{transform:scaleY(1)} }
    code { background:#111; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>ğŸ‰ NRL React Bot</h1>
  <p>Say <b>â€œHey React Bot â€¦â€</b> + your take. Pause â†’ get roasted ğŸ”¥</p>

  <button id="enable" class="btn">Enable Mic & Voice</button>
  <div id="status" class="support"></div>

  <div id="heard" class="box heard">ğŸ¤ Waitingâ€¦ click â€œEnable Mic & Voiceâ€ first.</div>
  <div id="reaction" class="box reaction" style="display:none;"></div>

  <!-- Face -->
  <div id="face">
    <div id="eyes"><div class="eye">ğŸ‘ï¸</div><div class="eye">ğŸ‘ï¸</div></div>
    <div id="mouth">ğŸ‘„</div>
  </div>

  <script>
    // --- Reactions (paste your huge list here if you want) ---
    const REACTIONS = [
      "That take's weaker than the Warriorsâ€™ defence after a beer break.",
      "Your take is like the Tigersâ€™ finals hopes â€” non-existent.",
      "Even the NRL refs couldnâ€™t make a call that bad.",
      "Thatâ€™s more cooked than a Cowboys' away game.",
      "Mate, that ideaâ€™s falling apart quicker than a Parra finals run.",
      "You sound like a bloke who picked Tigers for top 8 unironically.",
      "This chatâ€™s moving backwards faster than the Knightsâ€™ rebuild.",
      "You talk more rubbish than a Manly fan after a loss."
    ];

    // --- Elements ---
    const enableBtn  = document.getElementById('enable');
    const statusEl   = document.getElementById('status');
    const heardEl    = document.getElementById('heard');
    const reactEl    = document.getElementById('reaction');
    const mouthEl    = document.getElementById('mouth');

    // --- Feature detection ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasRecognition = !!SpeechRecognition;
    const hasSynthesis = 'speechSynthesis' in window;

    // Show support status
    (function showSupport() {
      const items = [];
      items.push(`Speech Recognition: ${hasRecognition ? 'âœ…' : 'âŒ (use Chrome/Edge)'}`);
      items.push(`Speech Synthesis: ${hasSynthesis ? 'âœ…' : 'âŒ'}`);
      items.push(`Secure context (HTTPS): ${window.isSecureContext ? 'âœ…' : 'âŒ'}`);
      statusEl.textContent = items.join(' â€¢ ');
    })();

    // --- Utilities ---
    const wait = (ms) => new Promise(r=>setTimeout(r, ms));
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const norm = (s) => s.toLowerCase().replace(/[^\w\s']/g,'').trim(); // basic normalize

    // Unlock audio & mic by user gesture, then loop
    enableBtn.addEventListener('click', async () => {
      enableBtn.disabled = true;
      heardEl.textContent = "ğŸ¤ Mic requestedâ€¦ allow the permission popup if prompted.";

      // Pre-warm speech synthesis (autoplay policies)
      if (hasSynthesis) {
        try {
          const u = new SpeechSynthesisUtterance("Ready.");
          u.volume = 0; // silent unlock
          u.rate = 1;
          u.lang = "en-AU";
          window.speechSynthesis.speak(u);
        } catch {}
      }

      // Ask for mic permission at least once so the browser shows the prompt
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        heardEl.textContent = "ğŸš« Mic permission denied. Please allow the mic and click again.";
        enableBtn.disabled = false;
        return;
      }

      if (!hasRecognition) {
        heardEl.textContent =
          "âš ï¸ Your browser doesnâ€™t support speech recognition. Use Chrome or Edge.\n" +
          "Alternative: wire this page to a server STT (e.g., Whisper/Vosk) via fetch/WebSocket.";
        enableBtn.disabled = false;
        return;
      }

      heardEl.textContent = "âœ… Mic enabled. Say â€œHey React Bot â€¦â€ whenever you like.";
      loopListen(); // start infinite loop
    });

    // Main loop: listen once -> maybe roast -> repeat
    async function loopListen() {
      while (true) {
        const transcript = await listenOnce();     // waits for a single utterance
        if (!transcript) { continue; }

        // show what we heard
        heardEl.textContent = "ğŸ‘‚ Heard: " + transcript;

        // wake phrase check
        const cleaned = norm(transcript);
        if (cleaned.startsWith("hey react")) {
          // extract what the user said after the wake phrase
          const after = transcript.slice(transcript.toLowerCase().indexOf("hey react bot") + "hey react bot".length).trim();
          await roast(after || transcript);
        }

        // small breather before next listen
        await wait(150);
      }
    }

    // Listen for one phrase (Chrome/Edge webkitSpeechRecognition is most reliable non-API way)
    function listenOnce() {
      return new Promise((resolve) => {
        const rec = new SpeechRecognition();
        rec.lang = "en-AU";
        rec.interimResults = true;   // show live text
        rec.maxAlternatives = 1;
        rec.continuous = false;      // one phrase, then end on its own pause

        let interim = "";
        let finalText = "";

        rec.onresult = (e) => {
          interim = "";
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const chunk = e.results[i][0].transcript;
            if (e.results[i].isFinal) {
              finalText += chunk;
            } else {
              interim += chunk;
            }
          }
          // live update
          const live = (finalText + " " + interim).trim();
          if (live) heardEl.textContent = "ğŸ‘‚ Heard: " + live;
        };

        rec.onerror = () => resolve("");
        rec.onend   = () => resolve((finalText || interim || "").trim());

        try {
          rec.start();
        } catch {
          // rare race; resolve quickly to keep loop going
          resolve("");
        }
      });
    }

    async function roast(userSaid) {
      // Pick roast
      const line = pick(REACTIONS);

      // Show on screen
      reactEl.style.display = "block";
      reactEl.textContent = `You said:\nâ€œ${userSaid}â€\n\nReact Bot:\nâ€œ${line}â€`;

      // Talk with mouth animation
      mouthEl.classList.add("talking");
      if (hasSynthesis) {
        const u = new SpeechSynthesisUtterance(line);
        u.lang = "en-AU";
        u.rate = 0.95;
        u.onend = () => mouthEl.classList.remove("talking");
        try { window.speechSynthesis.speak(u); }
        catch { mouthEl.classList.remove("talking"); }
      } else {
        // fallback: stop mouth after a short moment
        await wait(1200);
        mouthEl.classList.remove("talking");
      }
    }
  </script>
</body>
</html>
