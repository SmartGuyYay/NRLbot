<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NRL React Bot</title>
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; text-align:center; padding:32px 16px; }
    h1 { margin:0 0 10px; }
    .btn { padding:14px 22px; font-size:16px; border:0; border-radius:12px; cursor:pointer; background:#0ea5e9; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .box { max-width:700px; margin:16px auto; text-align:left; padding:14px 16px; border-radius:12px; }
    .heard { background:#121212; border:1px solid #2a2a2a; min-height:64px; white-space:pre-wrap; }
    .reaction { background:#1e1e1e; border:1px solid #3a3a3a; font-style:italic; }
    .support { margin-top:8px; opacity:.8; }
    #face { font-size:60px; margin-top:18px; }
    #eyes { display:flex; justify-content:center; gap:60px; margin-bottom:8px; }
    .eye { font-size:50px; }
    #mouth { font-size:60px; display:inline-block; transform-origin:center; }
    .talking { animation:talk .28s infinite; }
    @keyframes talk { 0%{transform:scaleY(1)} 50%{transform:scaleY(.35)} 100%{transform:scaleY(1)} }
  </style>
</head>
<body>
  <h1>ğŸ‰ NRL React Bot</h1>
  <p>Say <b>â€œHey React Bot â€¦â€</b> + your take. Pause â†’ get roasted ğŸ”¥</p>

  <button id="enable" class="btn">Enable Mic & Voice</button>
  <div id="status" class="support"></div>

  <div id="heard" class="box heard">ğŸ¤ Waitingâ€¦ click â€œEnable Mic & Voiceâ€ first.</div>
  <div id="reaction" class="box reaction" style="display:none;"></div>

  <!-- Face -->
  <div id="face">
    <div id="eyes"><div class="eye">ğŸ‘ï¸</div><div class="eye">ğŸ‘ï¸</div></div>
    <div id="mouth">ğŸ‘„</div>
  </div>

  <script>
    // ğŸ”‘ Replace with your Groq API key
    const GROQ_API_KEY = "gsk_YOUR_KEY_HERE";

    // --- Elements ---
    const enableBtn  = document.getElementById('enable');
    const statusEl   = document.getElementById('status');
    const heardEl    = document.getElementById('heard');
    const reactEl    = document.getElementById('reaction');
    const mouthEl    = document.getElementById('mouth');

    // --- Feature detection ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasRecognition = !!SpeechRecognition;
    const hasSynthesis = 'speechSynthesis' in window;

    // Show support status
    (function showSupport() {
      const items = [];
      items.push(`Speech Recognition: ${hasRecognition ? 'âœ…' : 'âŒ (use Chrome/Edge)'}`);
      items.push(`Speech Synthesis: ${hasSynthesis ? 'âœ…' : 'âŒ'}`);
      items.push(`Secure context (HTTPS): ${window.isSecureContext ? 'âœ…' : 'âŒ'}`);
      statusEl.textContent = items.join(' â€¢ ');
    })();

    // --- Utilities ---
    const wait = (ms) => new Promise(r=>setTimeout(r, ms));
    const norm = (s) => s.toLowerCase().replace(/[^\w\s']/g,'').trim();

    // Unlock audio & mic by user gesture, then loop
    enableBtn.addEventListener('click', async () => {
      enableBtn.disabled = true;
      heardEl.textContent = "ğŸ¤ Mic requestedâ€¦ allow the permission popup if prompted.";

      if (hasSynthesis) {
        try {
          const u = new SpeechSynthesisUtterance("Ready.");
          u.volume = 0;
          u.lang = "en-AU";
          window.speechSynthesis.speak(u);
        } catch {}
      }

      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        heardEl.textContent = "ğŸš« Mic permission denied.";
        enableBtn.disabled = false;
        return;
      }

      if (!hasRecognition) {
        heardEl.textContent =
          "âš ï¸ Browser doesnâ€™t support recognition. Use Chrome/Edge.";
        enableBtn.disabled = false;
        return;
      }

      heardEl.textContent = "âœ… Mic enabled. Say â€œHey React Bot â€¦â€";
      loopListen();
    });

    async function loopListen() {
      while (true) {
        const transcript = await listenOnce();
        if (!transcript) continue;

        heardEl.textContent = "ğŸ‘‚ Heard: " + transcript;

        const cleaned = norm(transcript);
        if (cleaned.startsWith("hey react")) {
          const after = transcript.slice(transcript.toLowerCase().indexOf("hey react bot") + "hey react bot".length).trim();
          await roast(after || transcript);
        }
        await wait(150);
      }
    }

    function listenOnce() {
      return new Promise((resolve) => {
        const rec = new SpeechRecognition();
        rec.lang = "en-AU";
        rec.interimResults = true;
        rec.maxAlternatives = 1;
        rec.continuous = false;

        let finalText = "";
        let interim = "";

        rec.onresult = (e) => {
          interim = "";
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const chunk = e.results[i][0].transcript;
            if (e.results[i].isFinal) finalText += chunk;
            else interim += chunk;
          }
          heardEl.textContent = "ğŸ‘‚ Heard: " + (finalText + " " + interim).trim();
        };

        rec.onerror = () => resolve("");
        rec.onend   = () => resolve((finalText || interim || "").trim());

        try { rec.start(); } catch { resolve(""); }
      });
    }

    async function roast(userSaid) {
      // Decide serious vs roast mode
      const is_question = userSaid.includes("?") || userSaid.toLowerCase().startsWith("what");
      const force_serious = userSaid.toLowerCase().includes("serious");
      let system_prompt = "";

      if (force_serious || (is_question && !force_serious)) {
        system_prompt = `You're React Bot: an Aussie NRL fan who can also answer normal questions properly and who supports the rugby league Amsterdam Cobras, but no NRL team. There are 3 R's in strawberry.
- Answer questions factually and clearly.
- Never swear.`;
      } else {
        system_prompt = `You're React Bot: a savage Aussie NRL fan who supports the Amsterdam Cobras.
- Respond with short, funny one-liner roasts.
- Use footy slang.
- Keep under 25 words.`;
      }

      // Call Groq
      const reply = await callGroq(system_prompt, userSaid);

      // Show
      reactEl.style.display = "block";
      reactEl.textContent = `You said:\nâ€œ${userSaid}â€\n\nReact Bot:\nâ€œ${reply}â€`;

      // Talk with mouth animation
      mouthEl.classList.add("talking");
      if (hasSynthesis) {
        const u = new SpeechSynthesisUtterance(reply);
        u.lang = "en-AU";
        u.rate = 0.95;
        u.onend = () => mouthEl.classList.remove("talking");
        try { window.speechSynthesis.speak(u); }
        catch { mouthEl.classList.remove("talking"); }
      } else {
        await wait(1200);
        mouthEl.classList.remove("talking");
      }
    }

    async function callGroq(system_prompt, user_input) {
      try {
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${GROQ_API_KEY}`
          },
          body: JSON.stringify({
            model: "llama3-8b-8192",
            messages: [
              { role: "system", content: system_prompt },
              { role: "user", content: user_input }
            ]
          })
        });
        const data = await res.json();
        return data.choices?.[0]?.message?.content || "(no response)";
      } catch (e) {
        return "âš ï¸ Error talking to Groq API.";
      }
    }
  </script>
</body>
</html>
